<html>
    <head>
        <title>Bike Training Zone Calculator</title>
        <style>
            table {
                font-family: arial, sans-serif;
                border-collapse: collapse;
                width: 618px;
            }

            td, th {
                border: 1px solid #dddddd;
                text-align: left;
                padding: 8px;
            }

            tr:nth-child(even) {
                background-color: #eeeeee;
            }
        </style>
    </head>
    <body>

        <input type="number" id="ftp" placeholder='FTP' size=13 />
        <input type="number" id="weight" placeholder='Weight (kg)' size=13 />
        <input type="number" id="age" placeholder='Age' size=13 />
        <select id="gender">
            <option value="" disabled selected>Select your gender</option>
            <option value="female">female</option>
            <option value="male">male</option>
            <option value="other">other</option>
        </select>

        <p id="physicalCondition"></p>
        <canvas id="progressionBar" height="0"></canvas>

        <table id='ftpTable'>
            <tr>
                <th>Train Zone</th>
                <th>Level</th>
                <th>Watt</th>
            </tr>
            <tr>
                <td>Zone 1</td>
                <td>Active recovery</td>
                <td>-</td>
            </tr>
            <tr>
                <td>Zone 2</td>
                <td>Endurance</td>
                <td>-</td>
            </tr>
            <tr>
                <td>Zone 3</td>
                <td>Tempo</td>
                <td>-</td>
            </tr>
            <tr>
                <td>Zone 4</td>
                <td>Threshold</td>
                <td>-</td>
            </tr>
            <tr>
                <td>Zone 5</td>
                <td>VO2max</td>
                <td>-</td>
            </tr>
            <tr>
                <td>Zone 6</td>
                <td>Anaerobic</td>
                <td>-</td>
            </tr>
            <tr>
                <td>Zone 7</td>
                <td>Neuromusculair</td>
                <td>-</td>
            </tr>
        </table>

        <script>
            document.getElementById("ftp").addEventListener("input", updateFTP);
            document.getElementById("age").addEventListener("input", updatePhysicalCondition);
            document.getElementById("weight").addEventListener("input", updatePhysicalCondition);
            document.getElementById("gender").addEventListener("change", updatePhysicalCondition);

            function updateFTP(event) {
                var ftpTable = document.getElementById("ftpTable");

                if (this.value && 10 < this.value) {
                    const zone1 = Math.floor(0.55 * this.value);
                    const zone2 = Math.floor(0.75 * this.value);
                    const zone3 = Math.floor(0.90 * this.value);
                    const zone4 = Math.floor(1.05 * this.value);
                    const zone5 = Math.floor(1.20 * this.value);
                    const zone6 = Math.floor(2.85 * this.value);

                    ftpTable.rows[1].cells[2].innerHTML = "< " + zone1;
                    ftpTable.rows[2].cells[2].innerHTML = zone1 + " - " + zone2;
                    ftpTable.rows[3].cells[2].innerHTML = zone2 + " - " + zone3;
                    ftpTable.rows[4].cells[2].innerHTML = zone3 + " - " + zone4;
                    ftpTable.rows[5].cells[2].innerHTML = zone4 + " - " + zone5;
                    ftpTable.rows[6].cells[2].innerHTML = zone5 + " - " + zone6;
                    ftpTable.rows[7].cells[2].innerHTML = "> " + zone6;
                } else {
                    ftpTable.rows[1].cells[2].innerHTML = "-";
                    ftpTable.rows[2].cells[2].innerHTML = "-";
                    ftpTable.rows[3].cells[2].innerHTML = "-";
                    ftpTable.rows[4].cells[2].innerHTML = "-";
                    ftpTable.rows[5].cells[2].innerHTML = "-";
                    ftpTable.rows[6].cells[2].innerHTML = "-";
                    ftpTable.rows[7].cells[2].innerHTML = "-";
                }

                updatePhysicalCondition();
            }

            const wattPerKilogramConditionTable = [
                ['male', 15, 30, 0, 2.7, '1'],
                ['male', 30, 35, 0, 2.5, '1'],
                ['male', 35, 40, 0, 2.3, '1'],
                ['male', 40, 45, 0, 2.1, '1'],
                ['male', 45, 50, 0, 1.9, '1'],
                ['male', 50, 55, 0, 1.6, '1'],
                ['male', 55, 60, 0, 1.4, '1'],
                ['male', 60, 99, 0, 1.2, '1'],
                ['male', 15, 30, 2.7, 3.1, '2'],
                ['male', 30, 35, 2.5, 2.9, '2'],
                ['male', 35, 40, 2.3, 2.7, '2'],
                ['male', 40, 45, 2.1, 2.5, '2'],
                ['male', 45, 50, 1.9, 2.3, '2'],
                ['male', 50, 55, 1.6, 2.1, '2'],
                ['male', 55, 60, 1.4, 1.8, '2'],
                ['male', 60, 99, 1.2, 1.6, '2'],
                ['male', 15, 30, 3.1, 3.9, '3'],
                ['male', 30, 35, 2.9, 3.7, '3'],
                ['male', 35, 40, 2.7, 3.5, '3'],
                ['male', 40, 45, 2.5, 3.3, '3'],
                ['male', 45, 50, 2.3, 3.1, '3'],
                ['male', 50, 55, 2.1, 2.9, '3'],
                ['male', 55, 60, 1.8, 2.7, '3'],
                ['male', 60, 99, 1.6, 2.5, '3'],
                ['male', 15, 30, 3.9, 4.3, '4'],
                ['male', 30, 35, 3.7, 4.1, '4'],
                ['male', 35, 40, 3.5, 3.9, '4'],
                ['male', 40, 45, 3.3, 3.7, '4'],
                ['male', 45, 50, 3.1, 3.5, '4'],
                ['male', 50, 55, 2.9, 3.5, '4'],
                ['male', 55, 60, 2.7, 3.1, '4'],
                ['male', 60, 99, 2.5, 2.9, '4'],
                ['male', 15, 30, 4.3, 4.8, '5'],
                ['male', 30, 35, 4.1, 4.5, '5'],
                ['male', 35, 40, 3.9, 4.3, '5'],
                ['male', 40, 45, 3.7, 4.1, '5'],
                ['male', 45, 50, 3.5, 4.0, '5'],
                ['male', 50, 55, 3.5, 3.7, '5'],
                ['male', 55, 60, 3.1, 3.5, '5'],
                ['male', 60, 99, 2.9, 3.3, '5'],
                ['male', 15, 30, 4.8, 5.6, '6'],
                ['male', 30, 35, 4.5, 5.4, '6'],
                ['male', 35, 40, 4.3, 5.2, '6'],
                ['male', 40, 45, 4.1, 5.0, '6'],
                ['male', 45, 50, 4.0, 4.8, '6'],
                ['male', 50, 55, 3.7, 4.5, '6'],
                ['male', 55, 60, 3.5, 4.3, '6'],
                ['male', 60, 99, 3.3, 4.1, '6'],
                ['male', 15, 30, 5.6, 6.5, '7'],
                ['male', 30, 35, 5.4, 6.5, '7'],
                ['male', 35, 40, 5.2, 6.5, '7'],
                ['male', 40, 45, 5.0, 6.5, '7'],
                ['male', 45, 50, 4.8, 6.5, '7'],
                ['male', 50, 55, 4.5, 6.5, '7'],
                ['male', 55, 60, 4.3, 6.5, '7'],
                ['male', 60, 99, 4.1, 6.5, '7'],
                ['female', 15, 30, 0, 2.3, '1'],
                ['female', 30, 35, 0, 2.1, '1'],
                ['female', 35, 40, 0, 1.9, '1'],
                ['female', 40, 45, 0, 1.7, '1'],
                ['female', 45, 50, 0, 1.6, '1'],
                ['female', 50, 55, 0, 1.4, '1'],
                ['female', 55, 60, 0, 1.2, '1'],
                ['female', 60, 99, 0, 1.1, '1'],
                ['female', 15, 30, 2.3, 2.6, '2'],
                ['female', 30, 35, 2.1, 2.4, '2'],
                ['female', 35, 40, 1.9, 2.2, '2'],
                ['female', 40, 45, 1.7, 2.1, '2'],
                ['female', 45, 50, 1.6, 1.9, '2'],
                ['female', 50, 55, 1.4, 1.8, '2'],
                ['female', 55, 60, 1.2, 1.5, '2'],
                ['female', 60, 99, 1.1, 1.3, '2'],
                ['female', 15, 30, 2.6, 3.3, '3'],
                ['female', 30, 35, 2.4, 3.1, '3'],
                ['female', 35, 40, 2.2, 2.8, '3'],
                ['female', 40, 45, 2.1, 2.7, '3'],
                ['female', 45, 50, 1.9, 2.6, '3'],
                ['female', 50, 55, 1.8, 2.4, '3'],
                ['female', 55, 60, 1.5, 2.2, '3'],
                ['female', 60, 99, 1.3, 2.0, '3'],
                ['female', 15, 30, 3.3, 3.6, '4'],
                ['female', 30, 35, 3.1, 3.4, '4'],
                ['female', 35, 40, 2.8, 3.2, '4'],
                ['female', 40, 45, 2.7, 3.0, '4'],
                ['female', 45, 50, 2.6, 2.9, '4'],
                ['female', 50, 55, 2.4, 2.7, '4'],
                ['female', 55, 60, 2.2, 2.6, '4'],
                ['female', 60, 99, 2.0, 2.4, '4'],
                ['female', 15, 30, 3.6, 4.0, '5'],
                ['female', 30, 35, 3.4, 3.8, '5'],
                ['female', 35, 40, 3.2, 3.6, '5'],
                ['female', 40, 45, 3.0, 3.4, '5'],
                ['female', 45, 50, 2.9, 3.3, '5'],
                ['female', 50, 55, 2.7, 3.0, '5'],
                ['female', 55, 60, 2.6, 2.9, '5'],
                ['female', 60, 99, 2.4, 2.7, '5'],
                ['female', 15, 30, 4.0, 4.6, '6'],
                ['female', 30, 35, 3.8, 4.4, '6'],
                ['female', 35, 40, 3.6, 4.2, '6'],
                ['female', 40, 45, 3.4, 4.1, '6'],
                ['female', 45, 50, 3.3, 3.9, '6'],
                ['female', 50, 55, 3.0, 3.7, '6'],
                ['female', 55, 60, 2.9, 3.5, '6'],
                ['female', 60, 99, 2.7, 3.3, '6'],
                ['female', 15, 30, 4.6, 6.5, '7'],
                ['female', 30, 35, 4.4, 6.5, '7'],
                ['female', 35, 40, 4.2, 6.5, '7'],
                ['female', 40, 45, 4.1, 6.5, '7'],
                ['female', 45, 50, 3.9, 6.5, '7'],
                ['female', 50, 55, 3.7, 6.5, '7'],
                ['female', 55, 60, 3.5, 6.5, '7'],
                ['female', 60, 99, 3.3, 6.5, '7'],
                ['other', 15, 30, 0, 2.7, '1'],
                ['other', 30, 35, 0, 2.5, '1'],
                ['other', 35, 40, 0, 2.3, '1'],
                ['other', 40, 45, 0, 2.1, '1'],
                ['other', 45, 50, 0, 1.9, '1'],
                ['other', 50, 55, 0, 1.6, '1'],
                ['other', 55, 60, 0, 1.4, '1'],
                ['other', 60, 99, 0, 1.2, '1'],
                ['other', 15, 30, 2.7, 3.1, '2'],
                ['other', 30, 35, 2.5, 2.9, '2'],
                ['other', 35, 40, 2.3, 2.7, '2'],
                ['other', 40, 45, 2.1, 2.5, '2'],
                ['other', 45, 50, 1.9, 2.3, '2'],
                ['other', 50, 55, 1.6, 2.1, '2'],
                ['other', 55, 60, 1.4, 1.8, '2'],
                ['other', 60, 99, 1.2, 1.6, '2'],
                ['other', 15, 30, 3.1, 3.9, '3'],
                ['other', 30, 35, 2.9, 3.7, '3'],
                ['other', 35, 40, 2.7, 3.5, '3'],
                ['other', 40, 45, 2.5, 3.3, '3'],
                ['other', 45, 50, 2.3, 3.1, '3'],
                ['other', 50, 55, 2.1, 2.9, '3'],
                ['other', 55, 60, 1.8, 2.7, '3'],
                ['other', 60, 99, 1.6, 2.5, '3'],
                ['other', 15, 30, 3.9, 4.3, '4'],
                ['other', 30, 35, 3.7, 4.1, '4'],
                ['other', 35, 40, 3.5, 3.9, '4'],
                ['other', 40, 45, 3.3, 3.7, '4'],
                ['other', 45, 50, 3.1, 3.5, '4'],
                ['other', 50, 55, 2.9, 3.5, '4'],
                ['other', 55, 60, 2.7, 3.1, '4'],
                ['other', 60, 99, 2.5, 2.9, '4'],
                ['other', 15, 30, 4.3, 4.8, '5'],
                ['other', 30, 35, 4.1, 4.5, '5'],
                ['other', 35, 40, 3.9, 4.3, '5'],
                ['other', 40, 45, 3.7, 4.1, '5'],
                ['other', 45, 50, 3.5, 4.0, '5'],
                ['other', 50, 55, 3.5, 3.7, '5'],
                ['other', 55, 60, 3.1, 3.5, '5'],
                ['other', 60, 99, 2.9, 3.3, '5'],
                ['other', 15, 30, 4.8, 5.6, '6'],
                ['other', 30, 35, 4.5, 5.4, '6'],
                ['other', 35, 40, 4.3, 5.2, '6'],
                ['other', 40, 45, 4.1, 5.0, '6'],
                ['other', 45, 50, 4.0, 4.8, '6'],
                ['other', 50, 55, 3.7, 4.5, '6'],
                ['other', 55, 60, 3.5, 4.3, '6'],
                ['other', 60, 99, 3.3, 4.1, '6'],
                ['other', 15, 30, 5.6, 6.5, '7'],
                ['other', 30, 35, 5.4, 6.5, '7'],
                ['other', 35, 40, 5.2, 6.5, '7'],
                ['other', 40, 45, 5.0, 6.5, '7'],
                ['other', 45, 50, 4.8, 6.5, '7'],
                ['other', 50, 55, 4.5, 6.5, '7'],
                ['other', 55, 60, 4.3, 6.5, '7'],
                ['other', 60, 99, 4.1, 6.5, '7'],
            ];

            function getWattPerKilogramMaxConditionLevel(wattPerKilogram, age, gender) {
                for (var i = 0; i < wattPerKilogramConditionTable.length; i++) {
                    const [gClass, ageMin, ageMax, wattPerKilogramMin, wattPerKilogramMax, level] = wattPerKilogramConditionTable[i];
                    if (gClass == gender
                            && ageMin <= age
                            && age < ageMax
                            && wattPerKilogramMin <= wattPerKilogram
                            && wattPerKilogram < wattPerKilogramMax) {
                        return level;
                    }
                };
            }

            function plotProgressionBar(wattPerKg, age, gender) {
                const progressionBar = document.getElementById("progressionBar");

                if (progressionBar.getContext) {
                    const ctx = progressionBar.getContext('2d');
                    const barWidth = 560/7;

                    const wattPerKgTable = wattPerKilogramConditionTable.filter((arr) => {
                        return arr[0] == gender && arr[1] <= age && age < arr[2];
                    });


                    if (wattPerKgTable.length != 7) {
                        progressionBar.width = 0;
                        progressionBar.height = 0;
                        return;
                    } else {
                        progressionBar.width = 600;
                        progressionBar.height = 60;
                    }

                    ctx.lineWidth = 3;

                    const colorPalette = ["#3288bd", "#99d594", "#e6f598", "#ffff00", "#fee08b", "#fc8d59", "#d53e4f"];
                    var progressionPosition = 20;
                    for (var i = 0; i < 7; i++) {
                        ctx.strokeStyle = colorPalette[i];
                        ctx.strokeRect(20 + i*barWidth, 19, barWidth - 1, 2);
                        ctx.fillText(wattPerKgTable[i][4].toFixed(1), 10 + (i + 1)*barWidth, 40);
                        if (wattPerKgTable[i][3] < wattPerKg && wattPerKg <= wattPerKgTable[i][4]) {
                            progressionPosition = 20 + (
                                i + (wattPerKg - wattPerKgTable[i][3]) / (wattPerKgTable[i][4] - wattPerKgTable[i][3])
                            ) * barWidth;
                        }
                    }

                    if (wattPerKgTable[6][4] < wattPerKg) {
                        progressionPosition = 20 + (
                            6 + (6.5 - wattPerKgTable[6][3]) / (wattPerKgTable[6][4] - wattPerKgTable[6][3])
                        ) * barWidth;
                    }

                    ctx.strokeStyle = "#000000";
                    ctx.fillText(wattPerKg.toFixed(2), progressionPosition - 10, 10);
                    ctx.beginPath();
                    ctx.moveTo(progressionPosition, 15);
                    ctx.lineTo(progressionPosition, 25);
                    ctx.closePath();
                    ctx.stroke();
                } else {
                    progressionBar.height = 0;
                    progressionBar.width = 0;
                }
            }

            function estimateVO2Max(ftp) {
                return ftp / 0.072;
            }

            function updatePhysicalCondition(event) {
                const ftpValue = document.getElementById("ftp").value;
                const weightValue = document.getElementById("weight").value;
                const ageValue = document.getElementById("age").value;
                const genderValue = document.getElementById("gender").value;

                const physicalCondition = document.getElementById("physicalCondition");
                if (ftpValue !== ""
                        && 0 < ftpValue
                        && ageValue !== ""
                        && 0 < ageValue
                        && weightValue !== ""
                        && 0 < weightValue
                        && genderValue !== "") {
                    const wattPerKg = ftpValue / weightValue;
                    const vo2Max = estimateVO2Max(wattPerKg);
                    const conditionLevel = getWattPerKilogramMaxConditionLevel(wattPerKg, ageValue, genderValue);

                    var resultTable = `<table id="resultTable">
                            <tr>
                                <td>Watt per kg:</td>
                                <td>${wattPerKg.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td>Estimated VO2max:</td>
                                <td>${vo2Max.toFixed(1)}</td>
                            </tr>
                            <tr>
                                <td>Condition level</td>
                                <td>${conditionLevel}</td>
                            </tr>
                        </table>`;
                    //if (typeof level !== "undefined") {
                    //    msg += "Fitness level: " + level + " out of 7";
                    //}
                    physicalCondition.innerHTML = resultTable;

                    plotProgressionBar(wattPerKg, ageValue, genderValue);
                } else {
                    physicalCondition.innerHTML = "";

                    const progressionBar = document.getElementById("progressionBar");
                    progressionBar.height = 0;
                }
            }
        </script>

    </body>
</html>
